name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Shared environment variables for consistency across jobs
env:
  XCODE_VERSION: 'latest-stable'

# Prevent duplicate runs on the same PR
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Lint job runs first on cheaper ubuntu runner
  lint:
    name: SwiftLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict

  # Format check job runs in parallel with lint
  format:
    name: SwiftFormat
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install SwiftFormat
        run: |
          # Install SwiftFormat via pre-built binary
          wget -q https://github.com/nicklockwood/SwiftFormat/releases/download/0.58.7/swiftformat_linux.zip
          unzip -q swiftformat_linux.zip
          chmod +x swiftformat_linux
          sudo mv swiftformat_linux /usr/local/bin/swiftformat
      - name: Check Formatting
        run: |
          swiftformat --lint . || {
            echo ""
            echo "❌ Code formatting issues found!"
            echo "Run 'swiftformat .' locally to fix formatting."
            exit 1
          }

  # Matrix build for all schemes - runs in parallel after lint and format
  build:
    name: Build ${{ matrix.scheme }}
    needs: [lint, format]
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        scheme: [Whisky, WhiskyCmd, WhiskyThumbnail]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      # Cache includes WhiskyKit/.build for consistency with test job cache paths
      # (swift build creates artifacts there, xcodebuild uses DerivedData)
      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
            .build
            WhiskyKit/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # SwiftLint build phase automatically skips when CI=true (set by GitHub Actions)
      - name: Build
        run: |
          xcodebuild -project Whisky.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -configuration Debug \
            build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

  # Test job for WhiskyKit - always runs to ensure coverage is uploaded
  test:
    name: Run Tests
    needs: [lint, format]
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      # Cache includes WhiskyKit/.build because swift build/test creates
      # build artifacts there (unlike xcodebuild which uses DerivedData)
      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
            .build
            WhiskyKit/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build WhiskyKit
        run: swift build --package-path WhiskyKit
      
      - name: Run Tests with Code Coverage
        run: swift test --package-path WhiskyKit --enable-code-coverage
          
      - name: Generate Coverage Report
        id: coverage
        run: |
          cd WhiskyKit

          # Debug: Show build directory structure
          echo "=== Build directory structure ==="
          find .build -type d -name "debug" 2>/dev/null | head -5

          echo "=== Looking for xctest bundles ==="
          find .build -name "*.xctest" -type d 2>/dev/null

          echo "=== Looking for profdata files ==="
          find .build -name "*.profdata" 2>/dev/null

          # Find the test binary - search entire .build directory for architecture-specific paths
          TEST_BINARY=""

          # Check for SPM test binary in xctest bundle (searches all architectures)
          XCTEST_BUNDLE=$(find .build -path "*debug*" -name "WhiskyKitPackageTests.xctest" -type d 2>/dev/null | head -1)
          if [ -n "$XCTEST_BUNDLE" ]; then
            BUNDLE_NAME=$(basename "$XCTEST_BUNDLE" .xctest)
            TEST_BINARY="$XCTEST_BUNDLE/Contents/MacOS/$BUNDLE_NAME"
            echo "=== Found xctest bundle: $XCTEST_BUNDLE ==="
            echo "=== Test binary path: $TEST_BINARY ==="
          fi

          # Verify the binary exists
          if [ ! -f "$TEST_BINARY" ]; then
            echo "=== Binary not in bundle, searching for standalone executable ==="
            TEST_BINARY=$(find .build -path "*debug*" -type f -name "WhiskyKitPackageTests" -perm +111 2>/dev/null | head -1)
            echo "=== Found: $TEST_BINARY ==="
          fi

          if [ -f "$TEST_BINARY" ]; then
            echo "=== Using test binary: $TEST_BINARY ==="

            PROFDATA=$(find .build -name "default.profdata" 2>/dev/null | head -1)
            if [ -n "$PROFDATA" ]; then
              echo "=== Using profdata: $PROFDATA ==="
              xcrun llvm-cov export \
                "$TEST_BINARY" \
                -instr-profile="$PROFDATA" \
                -format=lcov > coverage.lcov

              # Verify the coverage file was created and has content
              if [ -s coverage.lcov ]; then
                echo "✅ Coverage report generated successfully"
                echo "=== Coverage file size: $(wc -c < coverage.lcov) bytes ==="
                echo "=== First 20 lines of coverage.lcov ==="
                head -20 coverage.lcov
                echo "has_coverage=true" >> $GITHUB_OUTPUT
              else
                echo "❌ Coverage file is empty"
              fi
            else
              echo "❌ Warning: No profdata file found"
            fi
          else
            echo "❌ Warning: Could not find test binary"
            echo "=== Listing all executables in .build ==="
            find .build -path "*debug*" -type f -perm +111 2>/dev/null | grep -i test | head -20
          fi
      
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: WhiskyKit/coverage.lcov
          flags: whiskykit
          fail_ci_if_error: false
          verbose: true
      
      - name: Upload Coverage Report (Artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: WhiskyKit/coverage.lcov
          if-no-files-found: ignore
