name: Tests

on:
  push:
    branches: [main]
    paths:
      - 'WhiskyKit/**'
      - '.github/workflows/Test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'WhiskyKit/**'
      - '.github/workflows/Test.yml'
  workflow_dispatch:

jobs:
  test:
    name: Run WhiskyKit Tests
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build WhiskyKit
        run: swift build --package-path WhiskyKit
      
      - name: Run Tests
        run: swift test --package-path WhiskyKit
      
      - name: Run Tests with Code Coverage
        run: |
          swift test --package-path WhiskyKit --enable-code-coverage
          
      - name: Generate Coverage Report
        run: |
          cd WhiskyKit
          xcrun llvm-cov export \
            .build/debug/WhiskyKitPackageTests.xctest/Contents/MacOS/WhiskyKitPackageTests \
            -instr-profile=.build/debug/codecov/default.profdata \
            -format=lcov > coverage.lcov
        continue-on-error: true
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: WhiskyKit/coverage.lcov
        continue-on-error: true
