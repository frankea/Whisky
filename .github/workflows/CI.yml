name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# Shared environment variables for consistency across jobs
env:
  XCODE_VERSION: '16.2'

# Prevent duplicate runs on the same PR
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Lint job runs first on cheaper ubuntu runner
  lint:
    name: SwiftLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict

  # Matrix build for all schemes - runs in parallel after lint
  build:
    name: Build ${{ matrix.scheme }}
    needs: lint
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        scheme: [Whisky, WhiskyCmd, WhiskyThumbnail]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Skip SwiftLint build phase in CI - handled by lint job
      - name: Build
        run: |
          xcodebuild -project Whisky.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -configuration Debug \
            build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            SKIP_SWIFTLINT_BUILD_PHASE=YES

  # Test job for WhiskyKit
  test:
    name: Run Tests
    needs: lint
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/*/SourcePackages
            .build
            WhiskyKit/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build WhiskyKit
        run: swift build --package-path WhiskyKit
      
      - name: Run Tests with Code Coverage
        run: swift test --package-path WhiskyKit --enable-code-coverage
          
      - name: Generate Coverage Report
        run: |
          cd WhiskyKit
          xcrun llvm-cov export \
            .build/debug/WhiskyKitPackageTests.xctest/Contents/MacOS/WhiskyKitPackageTests \
            -instr-profile=.build/debug/codecov/default.profdata \
            -format=lcov > coverage.lcov
        continue-on-error: true
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: WhiskyKit/coverage.lcov
        continue-on-error: true
